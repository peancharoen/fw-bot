<!DOCTYPE html>
<html lang="en">
<head>
  <title>Wax bot</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/x-icon" href="/js/favicon.ico">
  <script src='/js/waxjs.js'></script>
  <script src="/js/tasktimer.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-5-strong">
    <ul class="nav navbar-nav nav-flex ml-auto">
      <li class="nav-item" style="display: none;"></li>
      <li class="nav-item"><span id="RPC" style="background-color: green; color: honeydew; font-size: smaller;"></span>&nbsp;<span id="waxusd" style="background-color: green; color: honeydew;"></span></li>
    </ul>
  </nav>

  <div class="container">
    <h1>SIMPLE Farming bot</h1>
    <div class="d-inline-block w-100">
      <div class="d-inline-block"><button class="btn btn-secondary btn-sm" type="button" id="login" onclick=login() >WAX Login</button></div>
      <div class="d-inline-block align-middle text-start" style="width: 120px;"><input type="text" class="form-control" id="updater" readonly></div>
      <div class="d-inline-block align-middle" style="width: 20%;">
        <div class="input-group">
          <span class="input-group-text" id="basic-addon1"><img src="/js/line.png" style="width: 16px;"></span>
          <input type="text" class="form-control " placeholder="LINE TOKEN HERE" aria-label="Username" aria-describedby="basic-addon1" id="lineToken">
        </div>
      </div>
      <div class="d-inline-block align-middle">
        <button class="btn btn-warning btn-sm" type="button" onclick=lineNotifyTest()>TEST LINE NOTIFY</button>
      </div>
    </div>
    <hr>
    <!-- <div class="row d-inline-flex" style="align-items: center;">
      <label class="align-middle">updater: </label><input id="updater" style="width: 90px;">&nbsp;<input id="lineToken" placeholder="LINE TOKEN HERE" style="width: 100px;">
      <button class="btn btn-warning btn-sm" type="button" onclick=lineNotifyTest()>TEST LINE NOTIFY</button><t></t>  -->
      <!-- &nbsp;<button class="btn btn-secondary btn-sm" type="button" id="sign" onclick=sign()>Sign transaction</button> -->
    <!-- </div> -->
    <!-- <label>message:</label> -->
    <input id="message" style="display:none;">
    <!-- <label>fail:</label> -->
    <input type="checkbox" id="fail" value="fail" style="display:none;"><t>
    
    <div class="d-inline-block w-100"><h5 id="usage"></h5></div>
    <!-- <label>Current Message</label> -->
    <h3 id="current" style="display:none;"></h3>
    <hr>
    <label>FarmersWorld</label>    <input type="checkbox" id="fwCheck" checked="true"></input>    <label id="fwBalance"></label>
    <!-- <br>DEPOSIT GOLD <input id="xx" placeholder="432.1234"> <button type="button" class="btn btn-outline-primary btn-sm" onclick=fwDepositFWG() id="fwDepositFWGButton">Deposit</button> -->
    <!-- <br>DEPOSIT FOOD <input id="fwDepositFWF" placeholder="432.1234"> <button type="button" class="btn btn-outline-primary btn-sm" onclick=fwDepositFWF() id="fwDepositFWFButton">Deposit</button><br><br> -->
    <div class="input-group mb-0" style="display: flex; align-items: center;">
      <div class="col-2"><span class="align-middle">DEPOSIT GOLD</span></div>
      <div class="col-3">
        <input id="fwDepositFWG" type="text" class="form-control" placeholder="321.1234" aria-label="321.1234" aria-describedby="basic-addon2">
      </div>
      <div class="col-3">  
        <button class="btn btn-warning" type="button" onclick=fwDepositFWG() id="fwDepositFWGButton">DEPOSIT</button>
      </div>
    </div>
    <div class="input-group mb-0" style="display: flex; align-items: center;">
      <div class="col-2"><span class="align-middle">DEPOSIT FOOD</span></div>
      <div class="col-3">
        <input id="fwDepositFWF" type="text" class="form-control" placeholder="321.1234" aria-label="321.1234" aria-describedby="basic-addon2">
      </div>
      <div class="col-3">  
        <button class="btn btn-primary" type="button" onclick=fwDepositFWF() id="fwDepositFWFButton">DEPOSIT</button>
      </div>
    </div>
    <br>
    <h5 id="resFarmersworld"></h5>
    <hr>
    <label>Officeland</label>    <input type="checkbox" id="officelandCheck" checked="true"></input>    <label id="officelandBalance"></label>
    <h5 id="resofficeland"></h5>
    <hr>
    <label>Transaction Results</label>
    <h5 id="response"></h5>
</div>
<button type="button" class="regular" name="edit" id="submit" style="display:none;"></button>
<script>
	// Common param
	const { TaskTimer } = tasktimer;
	const wax = new waxjs.WaxJS({
		rpcEndpoint: 'https://api.wax.alohaeos.com/', //'https://api.waxsweden.org', // // , 'https://wax.pink.gg'
        //rpcEndpoint: 'https://chain.wax.io/', //'https://wax.pink.gg', 'https://api.waxsweden.org', 'https://wax.eosphere.io',
		tryAutoLogin: true,
		waxSigningURL: "https://all-access.wax.io",
		waxAutoSigningURL: "https://api-idm.wax.io/v1/accounts/auto-accept/"
	});
	
	const fwToolsColor = {"Wood": "Sienna", "Food": "DodgerBlue", "Gold": "Gold"};
	const fwMembersColor = {"Bronze Member": "Khaki", "Silver Member": "Silver", "Gold Member": "Yellow"};
	//const nftPandaColor = {"earth": "Sienna", "water": "DodgerBlue", "fire": "Crimson", "wind": "MediumSeaGreen"};
  //const nftPandaWeapon = {"0": "Common", "1": "Uncommon", "2": "Rare", 
  //                        "3": "Epic", "4": "Legendary", "5": "Mythic"};
  //const nftPandaFEED = 3500;
	const fwRepair = 50;
	const fwRecover = 250;
  let toolconf;
	let cropconf;
	let mbconf;
  let animalconf;

	//const dropdownlistPandaFoodList = document.getElementById("pandaFoodList");
	//const dropdownlistPandaFoodUnit = document.getElementById("pandaFoodUnit");
	//const pandaFoodList = ["common", "uncommon", "rare", "epic", "legendary", "mythic"];
	//const pandaFoodPrice = [0.11, 0.22, 0.6, 1, 4, 12];
	//const pandaFoodUnit = [1, 5, 10, 20];
	//pandaFoodList.forEach(element => {
	//let option = document.createElement("OPTION");
	//option.innerHTML = element;
	//option.value = element;
	//dropdownlistPandaFoodList.options.add(option);
	//});

	//pandaFoodUnit.forEach(element => {
	//let option = document.createElement("OPTION");
	//option.innerHTML = element;
	//option.value = element;
	//dropdownlistPandaFoodUnit.options.add(option);
	//});
	const officelandJoblist = {"intern":2, "junior":3, "senior":4, "leader":5, "manager":6, "boss":6};
	const officelandColor = {"intern":"Silver", "junior":"MediumSeaGreen", 
                          "senior":"Gold", "leader":"MediumOrchid",
                          "manager":"OrangeRed", "boss":"DarkSlateBlue"};
	// GET TOKEN https://api.waxsweden.org/v2/state/get_account?account=
	// END  

	async function login() {
		try {
			const userAccount = await wax.login();
			document.getElementById('updater').value = userAccount;
			await getCurrentMessage();
			console.log("LOGIN SUCCESS!");
			toolconf = await getTableAll("farmersworld", "toolconfs", 100);
			cropconf = await getTableAll("farmersworld", "cropconf", 100);
			mbconf = await getTableAll("farmersworld", "mbsconf", 100);
			animalconf = await getTableAll("farmersworld", "cowconf", 100);
      await getUsage();
      document.getElementById("waxusd").innerHTML = "₩";
    } catch(e) {
			document.getElementById('response').append(e.message);
		}
	}

  async function getUsage(){
    let get_account;
    try{
      get_account = await fetch("https://api.waxsweden.org/v2/state/get_account?account="+wax.userAccount).then(response => response.json());
    }
    catch{
      get_account = await fetch("https://api.wax.alohaeos.com/v2/state/get_account?account="+wax.userAccount).then(response => response.json());
    }
    const cpuUsage = Math.floor(100*get_account.account.cpu_limit.used/get_account.account.cpu_limit.max);
    const waxInWallet = get_account.account.core_liquid_balance.split(" ")[0];
    let sInnerHTML = `<div class="progress" style="height: 25px; width: 75%; background-color: Silver;">
        <div class="badge d-inline bg-secondary text-white" style="font-size: medium;">${parseFloat(waxInWallet).toFixed(2)} WAX</div>&nbsp;
        <div class="progress-bar" role="progressbar" aria-valuemin="0"
          aria-valuemax="100" aria-valuenow="${cpuUsage}" style="width-max: 100%; width: ${cpuUsage*0.75}%;
          background-color: rgb(0, 0, 205); font-size: medium;"><b>CPU: ${cpuUsage}%</b></div>
      </div>`;
    document.getElementById("usage").innerHTML = sInnerHTML;

    get_account.tokens.forEach(token => {
      if(token.symbol == "FWG")
        document.getElementById("fwDepositFWG").placeholder = "Your have " + token.amount.toString() + " FWG";
      else if(token.symbol == "FWF")
        document.getElementById("fwDepositFWF").placeholder = "Your have " + token.amount.toString() + " FWF";
    });
  }

//////////////////////////////////GOTOFARMERSWORLD///////////////////////
  async function Farmersworld_main() {
    if (!document.getElementById("fwCheck").checked){
      return;
    }
    
    // let FWW = await fetch("https://wax.alcor.exchange/api/markets/104");
    // FWW = await FWW.json();
    // let FWF = await fetch("https://wax.alcor.exchange/api/markets/105");
    // FWF = await FWF.json();
    // let FWG = await fetch("https://wax.alcor.exchange/api/markets/106");
    // FWG = await FWG.json();

    const balance = await getTableRows("farmersworld", "accounts", wax.userAccount);
    const fee = await getTableRows("farmersworld", "config", "");
    
    let balanceGold = 0;
    let balanceFood = 0;
    let balanceWood = 0;
    balance.balances.forEach(item => {
    	if (item.includes("GOLD")) 
    		balanceGold = item.split(" ")[0];
    	else if(item.includes("FOOD"))
    		balanceFood = item.split(" ")[0];
    	else if(item.includes("WOOD"))
    		balanceWood = item.split(" ")[0];
    	}
    );

    // document.getElementById('fwBalance').innerHTML = `${balance.balances},<div class="badge d-inline bg-primary text-white">fee: ${fee.fee}%</div>`;
    
    let sInnerHTML = "";
    sInnerHTML += `<img src="/js/FWW.png"></img> ${parseFloat(balanceWood).toFixed(2)},&nbsp; 
		<img src="/js/FWF.png"></img> ${parseFloat(balanceFood).toFixed(2)},&nbsp;<img src="/js/FWG.png"></img> ${parseFloat(balanceGold).toFixed(2)}<br>`;
    sInnerHTML += `<div class="badge d-inline bg-info text-white" style="font-size: large;">Energy ${balance.energy}/${balance.max_energy}</div><br>`;
    sInnerHTML += "<br>Tools<br>";

    // document.getElementById('resFarmersworld').innerHTML = `<img src="/js/FWW.png"></img> ${parseFloat(FWW.last_price).toFixed(4)} WAX, 
		// <img src="/js/FWF.png"></img> ${parseFloat(FWF.last_price).toFixed(4)} WAX <img src="/js/FWG.png"></img> ${parseFloat(FWG.last_price).toFixed(4)} WAX<br>`;
    // document.getElementById('resFarmersworld').innerHTML += `<div class="badge d-inline bg-info text-white" style="font-size: large;">Energy ${balance.energy}/${balance.max_energy}</div><br>`;
    // document.getElementById('resFarmersworld').innerHTML += "<br>Tools<br>";
    sInnerHTML += await fwTools(balanceGold);
    
    sInnerHTML += "<br>Member<br>";
    // document.getElementById('resFarmersworld').innerHTML += "<br>Member<br>";
    sInnerHTML += await fwMembers();
    
    sInnerHTML += "<br>Animal<br>";
    // document.getElementById('resFarmersworld').innerHTML += "<br>Animal<br>";
    sInnerHTML += await fwAnimals();
	
    sInnerHTML += "<br>FarmPlot<br>";
    // document.getElementById('resFarmersworld').innerHTML += "<br>FarmPlot<br>";
    sInnerHTML += await fwCrops();
    document.getElementById('resFarmersworld').innerHTML = sInnerHTML;

    if (balance.energy < fwRecover)
    {
      let recover = balanceFood * 5;
      if (recover == 0)
      {
        $.ajax({
            type: "POST",
            url: "/submit",
            data: {
                  detail: `FW => Need more 🐟\n ${balanceFood} remains!\n` +
                  `Energy ${balance.energy}/${balance.max_energy}` 
              }
          });
          return;
      }
      if (recover > balance.max_energy) recover = balance.max_energy - balance.energy;
      let config = {
              actions: [{
                account: 'farmersworld',
                name: 'recover',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  owner: wax.userAccount,
                  energy_recovered: recover
                },
              }]
            };
        let ret = await sign(config);
        if (ret == true){console.log(`${recover} energy, RECOVER SUCCESS!`);}
        else{console.log(`${recover} energy, RECOVER FAILED! ${ret}`);}
    }
  }

  async function getTokensPrices() {
    // await getUsage();
    let price = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=WAX&vs_currencies=USD");
    price = await price.json();
    document.getElementById("waxusd").innerHTML = "&nbsp;₩: " + parseFloat(price.wax.usd).toFixed(4) +"&nbsp;";

    let SEST = await fetch("https://wax.alcor.exchange/api/markets/156");
    SEST = await SEST.json();
    await new Promise(r => setTimeout(r, 1000));
    let CBIT = await fetch("https://wax.alcor.exchange/api/markets/268");
    CBIT = await CBIT.json();

    document.getElementById('ftBalance').innerHTML = 
    `<div class="d-inline-block w-100">&nbsp;
      <div class="badge rounded-pill bg-light text-dark">
        <img src="/js/SEST.png" style='height: 15px;vertical-align: middle;align-items: center;'></img>&nbsp;${parseFloat(SEST.last_price).toFixed(4)} WAX</div>&nbsp;
      <div class="badge rounded-pill bg-light text-dark">
        <img src="/js/CBIT.png" style='height: 15px;vertical-align: middle;align-items: center;'></img>&nbsp;${parseFloat(CBIT.last_price).toFixed(4)} WAX</div>
    </div>`;

    let BAM = await fetch("https://wax.alcor.exchange/api/markets/155").then(res => res.json());
    document.getElementById('pandaBalance').innerHTML = 
    `<div class="d-inline-block w-100">&nbsp;
      <div class="badge rounded-pill bg-light text-dark">
        <img src="/js/BAM.png" style='height: 15px;vertical-align: middle;align-items: center;'></img>
        &nbsp;${parseFloat(BAM.last_price).toFixed(4)} WAX</div>
    </div>`;

    let Ocoin = await fetch("https://wax.alcor.exchange/api/markets/258").then(res => res.json());
    document.getElementById('officelandBalance').innerHTML = 
    `<div class="d-inline-block w-100">&nbsp;
      <div class="badge rounded-pill bg-light text-dark">
        <img src="/js/OCOIN.png" style='height: 15px;vertical-align: middle;align-items: center;'></img>
        &nbsp;${parseFloat(Ocoin.last_price).toFixed(4)} WAX</div>
    </div>`;

    let FWW = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://wax.alcor.exchange/api/markets/104/')}`)
                    .then(response => response.json());
    FWW = JSON.parse(FWW.contents);
	  
    let FWF = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://wax.alcor.exchange/api/markets/105/')}`)
                    .then(response => response.json());
    FWF = JSON.parse(FWF.contents);
	  
    let FWG = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://wax.alcor.exchange/api/markets/106/')}`)
                    .then(response => response.json());
    FWG = JSON.parse(FWG.contents);
	  
    document.getElementById('fwBalance').innerHTML = 
    `<div class="d-inline-block w-100">&nbsp;<div class="badge rounded-pill bg-light text-dark"><img src="/js/FWWtoken.png" style='height: 15px;vertical-align: middle;align-items: center;'></img>&nbsp;${parseFloat(FWW.last_price).toFixed(4)} WAX</div>
    &nbsp;<div class="badge rounded-pill bg-light text-dark"><img src="/js/FWFtoken.png" style='height: 15px;align-items: center;vertical-align: middle;'></img>&nbsp;${parseFloat(FWF.last_price).toFixed(4)} WAX</div>
    &nbsp;<div class="badge rounded-pill bg-light text-dark"><img src="/js/FWGtoken.png" style='height: 15px;align-items: center;vertical-align: middle;'></img>&nbsp;${parseFloat(FWG.last_price).toFixed(4)} WAX</div></div>`;
    
  }
      
	async function fwMembers(){
    let sInnerHTML = "";
		const mbs = await getTableRows_byIndex("farmersworld", "mbs", wax.userAccount, '2', 'name');
		mbs.forEach(async element => {
			const mbName = mbconf.rows.find(elem => elem.template_id === element.template_id);
			
      sInnerHTML += `<div class="d-inline-flex w-100">
						<div class="badge text-white" style="width: 130px; background-color: ${fwToolsColor[mbName.type]};">${mbName.name}</div>&emsp;
						<div class="badge" style="width: 120px;">&emsp;</div>&emsp;
						<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
					</div><br>`;
			// document.getElementById('resFarmersworld').innerHTML += `<div class="d-inline-flex w-100">
			// 			<div class="badge text-white" style="width: 130px; background-color: ${fwToolsColor[mbName.type]};">${mbName.name}</div>&emsp;
			// 			<div class="badge" style="width: 120px;">&emsp;</div>&emsp;
			// 			<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
			// 		</div><br>`;
      if (element.next_availability - Date.now()/1000 < 0){
        let config = {
              actions: [{
                account: 'farmersworld',
                name: 'mbsclaim',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  owner: wax.userAccount,
                  asset_id: element.asset_id
                },
              }]
            };
        let ret = await sign(config);
        if (ret == true){
          console.log(`Id ${ element.asset_id}, HARVEST SUCCESS!`);
          $.ajax({
              type: "POST",
              url: "/submit",
              data: {
                    detail: `FW => Member Id ${element.asset_id},🪓 HARVEST SUCCESS!\n` 
                }
            });
        }
        else{ console.log(`Id ${ element.asset_id}, HARVEST FAILED! ${ret}`); }
      }
    });
    return sInnerHTML;
  }
  
	async function fwAnimals(){
    let sInnerHTML = "";
		const animals = await getTableRows_byIndex("farmersworld", "animals", wax.userAccount, '2', 'name');
    animals.forEach(async element => {
		  	const animalName = animalconf.rows.find(elem => elem.template_id === element.template_id);
			//document.getElementById('resFarmersworld').append(`Id ${element.asset_id}, claimed ${element.times_claimed}/42, next_harvest ${sec2time(element.next_availability - Date.now()/1000)}`);
			sInnerHTML += `<div class="d-inline-flex w-100">
					<div class="badge bg-warning text-dark" style="width: 130px;">${animalName.name}</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${element.times_claimed}/42</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
				</div><br>`;
      // document.getElementById('resFarmersworld').innerHTML += `<div class="d-inline-flex w-100">
			// 		<div class="badge bg-warning text-dark" style="width: 130px;">${cropName.name}</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${element.times_claimed}/42</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
			// 	</div><br>`;
			if (element.next_availability - Date.now()/1000 < 0){
				let config = {
					  actions: [{
						account: 'farmersworld',
						name: 'anmclaim',
						authorization: [{
						  actor: wax.userAccount,
						  permission: 'active',
						}],
						data: {
						  owner: wax.userAccount,
						  crop_id: element.asset_id
						},
					  }]
					};
				let ret = await sign(config);
				if (ret == true){
					console.log(`Id ${ element.asset_id}, FEED SUCCESS!`);
				}
				else{
					console.log(`Id ${ element.asset_id}, FEED FAILED! ${ret}`);
				}
      		}
  	});
    return sInnerHTML;
  }
  
	async function fwCrops(){
    let sInnerHTML = "";
		const crops = await getTableRows_byIndex("farmersworld", "crops", wax.userAccount, '2', 'name');
		if(crops.length < 8)
    {
      const building = await getTableRows_byIndex("farmersworld", "buildings", wax.userAccount, '2', 'name');
      building.forEach(async element => {
        if(element.name == "Farm Plot" && element.slots_used < 8)
        {
          let seed = await fetch("https://wax.api.atomicassets.io/atomicassets/v1/assets?page=1&limit=1000&template_whitelist=298595&collection_name=farmersworld&owner=" + wax.userAccount).then(response => response.json());
          if(seed.data.length == 0)
          {
            seed = await fetch("https://wax.api.atomicassets.io/atomicassets/v1/assets?page=1&limit=1000&template_whitelist=298596&collection_name=farmersworld&owner=" + wax.userAccount).then(response => response.json());
          }
          let config = {
              actions: [{
                account: 'atomicassets',
                name: 'transfer',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  from: wax.userAccount,
                  to: "farmersworld",
                  asset_ids: [seed.data[0].asset_id],
                  memo: "stack"
                },
              }]
            };
        let ret = await sign(config);
        if (ret == true){console.log(`Id ${seed.data[0].asset_id}, STACK CROPS SUCCESS!`);}
        else {console.log(`Id ${seed.data[0].asset_id}, STACK CROPS FAILED! ${ret}`);}
        }
      });
    }
    crops.forEach(async element => {
		  	const cropName = cropconf.rows.find(elem => elem.template_id === element.template_id);
			//document.getElementById('resFarmersworld').append(`Id ${element.asset_id}, claimed ${element.times_claimed}/42, next_harvest ${sec2time(element.next_availability - Date.now()/1000)}`);
			sInnerHTML += `<div class="d-inline-flex w-100">
					<div class="badge bg-warning text-dark" style="width: 130px;">${cropName.name}</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${element.times_claimed}/42</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
				</div><br>`;
      // document.getElementById('resFarmersworld').innerHTML += `<div class="d-inline-flex w-100">
			// 		<div class="badge bg-warning text-dark" style="width: 130px;">${cropName.name}</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${element.times_claimed}/42</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
			// 	</div><br>`;
			if (element.next_availability - Date.now()/1000 < 0){
				let config = {
					  actions: [{
						account: 'farmersworld',
						name: 'cropclaim',
						authorization: [{
						  actor: wax.userAccount,
						  permission: 'active',
						}],
						data: {
						  owner: wax.userAccount,
						  crop_id: element.asset_id
						},
					  }]
					};
				let ret = await sign(config);
				if (ret == true){
					console.log(`Id ${ element.asset_id}, HARVEST SUCCESS!`);
				}
				else{
					console.log(`Id ${ element.asset_id}, HARVEST FAILED! ${ret}`);
				}
      		}
  	});
    return sInnerHTML;
  }
  
	async function fwTools(balanceGold){
    let sInnerHTML = "";
		const tools = await getTableRows_byIndex("farmersworld", "tools", wax.userAccount, '2', 'name');
		//tools.sort(function(a, b) {
    //  return a.template_id - b.template_id;
    //});
    tools.forEach(async element => {
      const toolName = toolconf.rows.find(elem => elem.template_id === element.template_id);
			
      sInnerHTML += `<div class="d-inline-flex w-100">
					<div class="badge text-white" style="width: 130px; background-color: ${fwToolsColor[toolName.type]};">${toolName.template_name}</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${element.current_durability}/${element.durability}</div>&emsp;
					<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
				</div><br>`;
			// document.getElementById('resFarmersworld').innerHTML += `<div class="d-inline-flex w-100">
			// 		<div class="badge text-white" style="width: 130px; background-color: ${fwToolsColor[toolName.type]};">${toolName.template_name}</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${element.current_durability}/${element.durability}</div>&emsp;
			// 		<div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(element.next_availability - Date.now()/1000)}</div>
			// 	</div><br>`;
			
      if (element.next_availability - Date.now()/1000 < 0){
        let config = {
              actions: [{
                account: 'farmersworld',
                name: 'claim',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  owner: wax.userAccount,
                  asset_id: element.asset_id
                },
              }]
            };
        let ret = await sign(config);
        if (ret == true){
          console.log(`Id ${ element.asset_id}, HARVEST SUCCESS!`);
          $.ajax({
              type: "POST",
              url: "/submit",
              data: {
                    detail: `FW => Id ${element.asset_id},🪓 HARVEST SUCCESS!\n` +
                    `current_durability: ${element.current_durability}/${element.durability}\n`+
                    `Energy ${balance.energy}/${balance.max_energy}` 
                }
            });
        }
        else{ console.log(`Id ${ element.asset_id}, HARVEST FAILED! ${ret}`); }
      }

      if (element.current_durability < fwRepair)
      {
        let goldNeed = (element.durability - element.current_durability) / 5;
        if ( goldNeed > balanceGold )
        {
          $.ajax({
            type: "POST",
            url: "/submit",
            data: {
                  detail: `FW => Need more 🎟️\n ${balanceGold} remains!\n` +
                  `current_durability: ${element.current_durability}/${element.durability}` 
              }
          });
          return;
        }

        let config = {
              actions: [{
                account: 'farmersworld',
                name: 'repair',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  asset_owner: wax.userAccount,
                  asset_id: element.asset_id
                },
              }]
            };
        let ret = await sign(config);
        if (ret == true){console.log(`Id ${ element.asset_id}, REPAIR SUCCESS!`);}
        else{console.log(`Id ${ element.asset_id}, REPAIR FAILED! ${ret}`);}
      }
    });
    return sInnerHTML;
  }
  
  async function fwDepositFWG(){
  	let goldAmount = document.getElementById('fwDepositFWG').value;
  	goldAmount = parseFloat(goldAmount).toFixed(4);
  	const _memo = "deposit";
  	const _quantity = [`${goldAmount} FWG`];
  	console.log(_quantity);
  	let config = {
              actions: [{
                account: 'farmerstoken',
                name: 'transfers',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  from: wax.userAccount,
                  to: "farmersworld",
                  quantities: _quantity,
                  memo: _memo
                },
              }]
            };
    let ret = await sign(config);
    if (ret == true){
        console.log(`DEPOSIT ${goldAmount} FWG DONE!`);
    }
    else { 
        console.log(`DEPOSIT FAILED`);
    }
  }
  
    async function fwDepositFWF(){
  	let foodAmount = document.getElementById('fwDepositFWF').value;
  	foodAmount = parseFloat(foodAmount).toFixed(4);
  	const _memo = "deposit";
  	const _quantity = [`${foodAmount} FWF`];
  	console.log(_quantity);
  	let config = {
              actions: [{
                account: 'farmerstoken',
                name: 'transfers',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  from: wax.userAccount,
                  to: "farmersworld",
                  quantities: _quantity,
                  memo: _memo
                },
              }]
            };
    let ret = await sign(config);
    if (ret == true){
        console.log(`DEPOSIT ${foodAmount} FWG DONE!`);
    }
    else { 
        console.log(`DEPOSIT FAILED`);
    }
  }
	async function sign(configTranscat) {
    if(!wax.api) {
      return document.getElementById('response').innerHTML = '* Login first *';
    }

    const updater = document.getElementById('updater').value;
    const message = document.getElementById('message').value;
    const fail = document.getElementById('fail').checked;

    try {
      const result = await wax.api.transact(configTranscat, {
        blocksBehind: 3,
        expireSeconds: 30
      });
      
      document.getElementById('response').innerText = JSON.stringify(result);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return true;
      // await getCurrentMessage();
    } catch(e) {
      document.getElementById('response').innerText = e.message;
      return e.message;
    }
  }

  async function getTableRows_byIndex(code, tableName, bound, index, key_type){
    if (typeof(code) != "string" || 
        typeof(bound) != "string" || 
        typeof(tableName) != "string" || 
        typeof(index) != "string" || 
        typeof(key_type) != "string") {
      return false;
    }
    let result;
    try {
      result = await wax.api.rpc.get_table_rows({
        json: true,               // Get the response as json
        code: code,      // Contract that we target
        scope: code,         // Account that owns the data
        table: tableName,        // Table name
        index_position: index,
        key_type: key_type,
        lower_bound: bound,
        upper_bound: bound,
        reverse: false,           // Optional: Get reversed data
    });
    } catch(e) {
      document.getElementById('response').innerHTML = e.message;
      console.log("ERROR FOR: " + code + ", " + tableName + ", " + bound);
    }
    return result.rows;
  }

  async function getTableRows(code, tableName, bound, limit=1){
    if (typeof(code) != "string" || 
        typeof(bound) != "string" || 
        typeof(tableName) != "string") {
      return false;
    }
    let result;
    try {
      result = await wax.api.rpc.get_table_rows({
        json: true,               // Get the response as json
        code: code,      // Contract that we target
        scope: code,         // Account that owns the data
        table: tableName,        // Table name
        lower_bound: bound,
        upper_bound: bound,
        limit: limit,                // Maximum number of rows that we want to get
        reverse: false,           // Optional: Get reversed data
        show_payer: false          // Optional: Show ram payer
    });
    } catch(e) {
      document.getElementById('response').append(e.message);
      console.log("ERROR FOR: " + code + ", " + tableName + ", " + bound);
    }
    return result.rows[0];
  }
  
  async function getTableAll(code, tableName, limit=100){
    let result;
    try {
      result = await wax.api.rpc.get_table_rows({
      json: true,               // Get the response as json
      code: code,      // Contract that we target
      scope: code,         // Account that owns the data
      table: tableName,        // Table name
      lower_bound: "",
      upper_bound: "",
      limit: limit,                // Maximum number of rows that we want to get
      reverse: false,           // Optional: Get reversed data
      show_payer: false          // Optional: Show ram payer
    });
    } catch(e) {
      document.getElementById('response').append(e.message);
      console.log("ERROR FOR: " + code + ", " + tableName);
    }
    return result;
    }
//////////////////////////////////GOTOOFFICELAND///////////////////////
  async function Officeland_task(){
    let sInnerHTML = "";
    if (!document.getElementById("officelandCheck").checked){
      return;
    }
    
    let officelandBalance = await getTableRows("officegameio", "balances", wax.userAccount);
    // document.getElementById('officelandBalance').innerHTML = officelandBalance.quantity;
    // document.getElementById('resofficeland').innerHTML = `Ocoin: ${Ocoin.last_price}<br>`;
    sInnerHTML += `<div class="d-inline-flex w-100">
      <div class="badge bg-warning text-white" style="width: 180px;">${officelandBalance.quantity}</div></div>`;
    // Get pulbicspace //
    let res = await getTableRows("officegameio", "publicspace", wax.userAccount);
    if (!res){
      console.log("GET STAFF ERROR");
      return;
    }    
    res = res.asset_ids.filter(x => x!=0);

    for (let i=0; i<res.length; i++){
      let ret = [];
      ret = await getTableRows_byIndex("officegameio", 'taskassign', res[i].toString(), "2", "i64");
      let template_id = await fetch("https://wax.api.atomicassets.io/atomicmarket/v1/assets/" + res[i].toString()).then(response => response.json());
      if (ret.length == 0){
      	// let jobNum = await getTableRows_byIndex("officegameio", 'rarity', template_id, "2", "i64");
      	let jobNum = officelandJoblist[template_id.data.data.rarity];
        let config = {
              actions: [{
                account: 'officegameio',
                name: 'assigntask',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  player: wax.userAccount,
                  task_id: jobNum,
                  asset_id: res[i].toString()
                },
              }]
            };
        let ret_sign = await sign(config);
        if (ret_sign == true){
          console.log(`Id ${res[i].toString()}, GO WORK SUCCESS!`);
        }
        else { console.log(`Id ${res[i].toString()}, GO WORK FAILED! ${ret}`); }
        continue;
      }
      // document.getElementById('resofficeland').append(`asset_id ${res[i]}, next_harvest ${sec2time(ret[0].task_end - Date.now()/1000)}`);
      // document.getElementById('resofficeland').innerHTML += "<br>";
      sInnerHTML += `<div class="d-inline-flex w-100">
					<div class="badge text-white" style="width: 120px; background-color: ${officelandColor[template_id.data.data.rarity]};">${template_id.data.data.name}</div>&emsp;
          <div class="badge bg-secondary text-white" style="width: 120px;">${sec2time(ret[0].task_end - Date.now()/1000)}</div>
				</div><br>`;
      if (ret[0].task_end - Date.now()/1000 < 0){
      	let config = {
              actions: [{
                account: 'officegameio',
                name: 'taskfinished',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  player: wax.userAccount,
                  taskassign_id: ret[0].taskassign_id.toString()
                },
              }]
            };
        let ret_sign = await sign(config);
        if (ret_sign == true){
          console.log(`Id ${res[i].toString()}, FINISHED TASK!`);
        }
      }
    }
    
    res = await getTableRows("officegameio", 'waitclaims', wax.userAccount);
    res = res.claim_datas[0]
    if ((Date.now()/1000 - res.finish_time)/86400 > 6){
    	let config = {
              actions: [{
                account: 'officegameio',
                name: 'claimreward',
                authorization: [{
                  actor: wax.userAccount,
                  permission: 'active',
                }],
                data: {
                  player: wax.userAccount,
                  finish_id: res.finish_id.toString()
                },
              }]
            };
        let ret_sign = await sign(config);
    }
    document.getElementById('resofficeland').innerHTML = sInnerHTML;
  }

  async function getCurrentMessage() {
    const res = await wax.rpc.get_table_rows({
      json: true,
      code: 'test.wax',
      scope: 'test.wax',
      table: 'messages',
      lower_bound: wax.userAccount,
      upper_bound: wax.userAccount,
    });

    const message = res.rows[0] ? res.rows[0].message : `<No message is set for ${wax.userAccount}>`;
    document.getElementById('current').textContent = message;
  }

// --------------------------------------------Run at init---------------------------------------//
  // set a random value to the initial message value
  document.getElementById('message').value = Math.random().toString(36).substring(2);
  login(); // get onetime table

	const count = 10;
	const timerMain = new TaskTimer(1000);
  timerMain.add([
    {
      id: 'FarmersWorld',       // unique ID of the task
      // tickDelay: 1,       // 1 tick delay before first run
      tickInterval: 17,   // run every 10 ticks (10 x interval = 10000 ms)
      totalRuns: 0,       // run 2 times only. (set to 0 for unlimited times)
      callback(task) {
          // timerlogin.reset();
          console.log(`${task.id} task has run ${task.currentRuns} times.`);
          Farmersworld_main();
      }
    },
    {
      id: 'officeland',       // unique ID of the task
      // tickDelay: 1,       // 1 tick delay before first run
      tickInterval: 71,   // run every 10 ticks (10 x interval = 10000 ms)
      totalRuns: 0,       // run 2 times only. (set to 0 for unlimited times)
      callback(task) {
          // timerlogin.reset();
          console.log(`${task.id} task has run ${task.currentRuns} times.`);
          Officeland_task();
      }
    },
    {
      id: 'tokenPrice',       // unique ID of the task
      // tickDelay: 0,       // 1 tick delay before first run
      tickInterval: 113,   // run every 10 ticks (10 x interval = 10000 ms)
      totalRuns: 0,       // run 2 times only. (set to 0 for unlimited times)
      callback(task) {
          // timerlogin.reset();
          console.log(`${task.id} task has run ${task.currentRuns} times.`);
          getTokensPrices();
      }
    }
    
  ]);
  timerMain.start()

  function sec2time(timeInSeconds) {
    var pad = function(num, size) { return ('000' + num).slice(size * -1); },
    time = parseFloat(timeInSeconds).toFixed(3),
    hours = Math.floor(time / 60 / 60),
    minutes = Math.floor(time / 60) % 60,
    seconds = Math.floor(time - minutes * 60),
    milliseconds = time.slice(-3);
	return pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2);
    //return pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2) + ',' + pad(milliseconds, 3);
  }

</script>
</body>
</html>